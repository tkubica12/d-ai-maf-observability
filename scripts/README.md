# Build Scripts

This directory contains the build and deployment automation scripts for the MAF Observability Demo.

## build_and_push.py

Python script that builds and pushes Docker images to Azure Container Registry (ACR) using remote build tasks.

### Prerequisites

- Azure CLI installed and logged in (`az login`)
- Python 3.8+ with `python-dotenv` package
- Terraform infrastructure deployed (generates required `.env` file)

### Usage

1. **Deploy infrastructure first** to generate the `.env` configuration:
   ```bash
   cd ../infra
   terraform apply
   ```

2. **Run the build script**:
   ```bash
   # Using uv (recommended)
   uv run python build_and_push.py
   
   # Or using system Python
   pip install python-dotenv
   python build_and_push.py
   ```

### What it does

1. Reads ACR configuration from `.env` file (generated by Terraform)
2. Reads current image versions from `../infra/images.auto.tfvars`
3. Increments version numbers (v1 → v2 → v3, etc.)
4. Builds both `api-tool` and `mcp-tool` images using ACR remote build
5. Updates `images.auto.tfvars` with new version tags
6. Provides next steps for deployment

### Configuration

The script reads configuration from `.env` file:
- `AZURE_RESOURCE_GROUP_NAME` - Resource group containing the ACR
- `AZURE_ACR_NAME` - Name of the Azure Container Registry
- `AZURE_ACR_LOGIN_SERVER` - ACR login server URL (for reference)

This file is automatically generated by Terraform and should not be edited manually.

### Versioning

The script uses sequential versioning starting from v1:
- First build: v1
- Second build: v2
- Third build: v3
- And so on...

Version information is stored in `../infra/images.auto.tfvars` and automatically used by Terraform for Helm deployments.

### Workflow

1. Build images: `uv run build_and_push.py`
2. Deploy to AKS: `cd ../infra && terraform apply`
3. Verify deployment: `kubectl get pods -n maf-demo`
4. Run scenarios: `kubectl exec -it -n maf-demo <agent-pod> -- /bin/bash`